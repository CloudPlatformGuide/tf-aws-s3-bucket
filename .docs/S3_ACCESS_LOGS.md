# Understanding S3 Access Logs

Server access logging provides detailed records about the requests that are made to an Amazon S3 bucket. These logs can be invaluable for security audits, troubleshooting operational issues, and understanding your bucket's usage patterns.

## Enabling Access Logging in Terraform

This module allows you to enable access logging by configuring the `logging` variable:

```hcl
module "s3_bucket" {
  source = "path/to/this/module"

  bucket = "my-bucket"

  logging = {
    target_bucket = "log-bucket"
    target_prefix = "logs/my-bucket/"
  }

  # Other configuration...
}
```

## S3 Access Log Format

Each log entry in an S3 access log contains space-delimited fields. Below is a breakdown of these fields, with an example log entry parsed field by field.

### Example Log Entry

```
a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0 example-bucket [17/May/2025:00:05:23 +0000] 192.0.2.1 arn:aws:iam::123456789012:user/alice 8KFHDT6K REST.GET.OBJECT photos/2025/vacation.jpg "GET /photos/2025/vacation.jpg HTTP/1.1" 200 - 4025 4025 32 29 "-" "Mozilla/5.0" - t5h4j3k2L1m0N9o8P7q6R5s4T3u2V1 SigV4 TLS_AES_128_GCM_SHA256 AuthHeader example-bucket.s3.amazonaws.com TLSv1.3 - -
```

### Log Fields Explanation

| Field # | Name                | Example Value                            | Description                                                         |
| ------- | ------------------- | ---------------------------------------- | ------------------------------------------------------------------- |
| 1       | Bucket Owner        | a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0 | The canonical user ID of the bucket owner                           |
| 2       | Bucket              | example-bucket                           | Name of the bucket                                                  |
| 3       | Time                | [17/May/2025:00:05:23 +0000]             | Time when the request was received (UTC)                            |
| 4       | Remote IP           | 192.0.2.1                                | IP address of the requester                                         |
| 5       | Requester           | arn:aws:iam::123456789012:user/alice     | The IAM identity of the requester                                   |
| 6       | Request ID          | 8KFHDT6K                                 | A string generated by Amazon S3 to uniquely identify each request   |
| 7       | Operation           | REST.GET.OBJECT                          | The operation type                                                  |
| 8       | Key                 | photos/2025/vacation.jpg                 | The "key" or object requested                                       |
| 9       | Request-URI         | "GET /photos/2025/vacation.jpg HTTP/1.1" | The complete HTTP request line                                      |
| 10      | HTTP Status         | A200                                     | The HTTP status code for the request                                |
| 11      | Error Code          | -                                        | Error code, if an error occurred (hyphen if no error)               |
| 12      | Bytes Sent          | 4025                                     | Number of response bytes sent, excluding HTTP headers               |
| 13      | Object Size         | 4025                                     | Total size of the object                                            |
| 14      | Total Time          | 32                                       | Time in milliseconds to complete the request                        |
| 15      | Turn-Around Time    | 29                                       | Time in milliseconds that the request spent in processing within S3 |
| 16      | Referer             | "-"                                      | The HTTP Referer header                                             |
| 17      | User-Agent          | "Mozilla/5.0"                            | The HTTP User-Agent header                                          |
| 18      | Version ID          | -                                        | The version ID of the object (if versioning is enabled)             |
| 19      | Host ID             | t5h4j3k2L1m0N9o8P7q6R5s4T3u2V1           | A string AWS can use to debug requests                              |
| 20      | Signature Version   | SigV4                                    | The AWS signature version used                                      |
| 21      | Cipher Suite        | TLS_AES_128_GCM_SHA256                   | The TLS cipher suite used for HTTPS requests                        |
| 22      | Authentication Type | AuthHeader                               | Type of authentication used                                         |
| 23      | Host Header         | example-bucket.s3.amazonaws.com          | The endpoint used to make the request                               |
| 24      | TLS Version         | TLSv1.3                                  | TLS/SSL version used                                                |
| 25+     | Reserved            | - -                                      | Additional fields reserved for future use                           |

## Common Operation Types

S3 logs record various operation types, which are prefixed with the API used (REST, SOAP, WEBSITE):

| Operation             | Description            |
| --------------------- | ---------------------- |
| REST.GET.OBJECT       | Retrieve an object     |
| REST.PUT.OBJECT       | Upload an object       |
| REST.DELETE.OBJECT    | Delete an object       |
| REST.GET.BUCKET       | List bucket contents   |
| REST.PUT.BUCKET       | Create a bucket        |
| REST.DELETE.BUCKET    | Delete a bucket        |
| REST.POST.UPLOAD      | Multipart upload       |
| REST.PUT.BUCKETPOLICY | Update bucket policy   |
| REST.GET.BUCKETPOLICY | Retrieve bucket policy |
| REST.GET.BUCKETACL    | Retrieve bucket ACL    |
| REST.PUT.BUCKETACL    | Update bucket ACL      |
| WEBSITE.GET.OBJECT    | Web hosting access     |

## Common Error Codes

When a request is unsuccessful, S3 will include an error code:

| Error Code                   | Description                                        |
| ---------------------------- | -------------------------------------------------- |
| NoSuchBucket                 | The specified bucket does not exist                |
| NoSuchKey                    | The specified key does not exist                   |
| AccessDenied                 | Access was denied due to insufficient permissions  |
| InvalidRequest               | The request was invalid                            |
| MalformedPolicy              | The policy document was invalid                    |
| NoSuchCORSConfiguration      | No CORS configuration exists for the bucket        |
| NoSuchLifecycleConfiguration | No lifecycle configuration exists for the bucket   |
| InvalidArgument              | Invalid argument provided in the request           |
| RequestTimeTooSkewed         | The request time is too far apart from server time |
| SignatureDoesNotMatch        | The request signature was invalid                  |

## Troubleshooting Tips Using S3 Access Logs

1. **Authentication Issues**: Look for `AccessDenied` error codes and check the `Requester` field to see who attempted the operation.

2. **Operational Issues**: Check the `HTTP Status` and `Error Code` fields for non-200 responses.

3. **Performance Investigation**: Analyze the `Total Time` and `Turn-Around Time` fields for slow requests.

4. **Security Incidents**: Monitor for unexpected operations from unusual IP addresses or unauthorized requesters.

5. **Resource Usage**: Track the `Bytes Sent` and number of requests to understand your bucket's usage patterns.

## Processing S3 Access Logs

Due to the high volume of logs, it's recommended to use tools to analyze them:

- **Amazon Athena**: Query logs directly in S3 using SQL
- **Amazon CloudWatch Logs**: Configure S3 to push logs to CloudWatch for metrics and alerting
- **Log aggregation services**: Use services like Splunk, ELK Stack, or Sumo Logic
- **AWS Lambda**: Process logs in real-time with Lambda functions

## Best Practices

1. **Separate Log Bucket**: Always use a separate bucket for storing logs to avoid circular logging.

2. **Log Retention**: Implement lifecycle rules on your log bucket to manage costs.

3. **Prefix Organization**: Use meaningful prefixes to organize logs by date, application, or environment.

4. **Access Control**: Restrict access to the logging bucket to prevent tampering with logs.

5. **Regular Analysis**: Schedule regular reviews of logs to identify issues proactively.

## More Information

For more details on S3 access logging, refer to the [Amazon S3 Developer Guide](https://docs.aws.amazon.com/AmazonS3/latest/dev/ServerLogs.html).
